rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    function isAdmin() {
      // Check for custom claim or admin collection (simplified for MVP)
      return isSignedIn() && (request.auth.token.admin == true || exists(/databases/$(database)/documents/adminUsers/$(request.auth.uid)));
    }

    // --- Users Collection ---
    match /users/{userId} {
      // Anyone signed in can read basic profile info for matching/events
      // In production, you might want to limit this further (e.g. only if matched)
      allow read: if isSignedIn();
      // Only owner can update their profile
      allow create, update: if isOwner(userId);
      // No delete for MVP (or only admin)
      allow delete: if isAdmin();
    }

    // --- Swipes (Matching) ---
    match /swipes/{userId}/given/{otherUserId} {
      allow read: if isOwner(userId);
      allow create: if isOwner(userId);
      // Prevent changing a swipe once made (optional business rule)
      allow update: if false;
    }

    // --- Matches ---
    match /matches/{matchId} {
      // Only participants (userA or userB) can read
      allow read: if isSignedIn() && (resource.data.userA == request.auth.uid || resource.data.userB == request.auth.uid);
      // Created by server (cloud functions) or transaction securely
      allow create: if isSignedIn(); 
    }

    // --- Chats (1-on-1) ---
    match /chats/{chatId} {
       allow read: if isSignedIn() && request.auth.uid in resource.data.participants;
       allow create: if isSignedIn(); // Should validate participants
       allow update: if isSignedIn() && request.auth.uid in resource.data.participants;
    }

    match /chats/{chatId}/messages/{messageId} {
       allow read: if isSignedIn() && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
       allow create: if isSignedIn() && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
    }

    // --- Events ---
    match /events/{eventId} {
      allow read: if true; // Public events
      allow create: if isSignedIn(); // Any auth user can create an event (or restrict to verified)
      allow update: if isOwner(resource.data.organizerId) || isAdmin();
      allow delete: if isOwner(resource.data.organizerId) || isAdmin();
    }

    match /events/{eventId}/rsvps/{userId} {
      allow read: if isSignedIn();
      allow write: if isOwner(userId);
    }

    // --- Group Chats (Event) ---
    // User must have RSVP 'going' (simplified check or rely on Cloud Functions to add them to 'participants' array in groupChat doc)
    match /groupChats/{eventId} {
       allow read: if isSignedIn(); // Open to read metadata? Or restricted?
    }
    
    match /groupChats/{eventId}/messages/{messageId} {
      // Start with simple rule: must be signed in. In prod: check if user RSVP is 'going'.
      allow read, create: if isSignedIn(); 
    }

    // --- Verification Requests ---
    match /verificationRequests/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow create: if isOwner(userId);
      allow update: if isAdmin(); // Only admin approves/rejects
    }

    // --- Reports and Blocks ---
    match /blocks/{userId}/blocked/{otherUserId} {
       allow read, write: if isOwner(userId);
    }

    match /reports/{reportId} {
      allow create: if isSignedIn() && request.resource.data.reporterId == request.auth.uid;
      allow read: if isAdmin();
    }
  }
}
